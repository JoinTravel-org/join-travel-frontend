name: Deploy

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-24.04
    environment: >
      ${{
        (github.ref_name == 'main' && 'prod') ||
        (github.ref_name == 'dev' && 'test') ||
        'unknown'
      }}

    # üß† This condition ensures:
    # - Always run for "push" on "dev"
    # - Run for "push" on "main"
    # - Run for "merged PR" into main
    # - ‚ùå Skip when event is "pull_request" coming from dev
    if: |
      (github.event_name == 'push' && github.ref_name == 'dev') ||
      (github.event_name == 'push' && github.ref_name == 'main') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.base_ref == 'main')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display selected environment
        run: |
          echo "üåç Git branch: ${GITHUB_REF_NAME}"
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "üîß Using environment: prod"
          elif [[ "${GITHUB_REF_NAME}" == "dev" ]]; then
            echo "üîß Using environment: test"
          else
            echo "‚ö†Ô∏è Unsupported branch, stopping."
            exit 1
          fi

      - name: Trigger Coolify deployment
        id: trigger
        env:
          COOLIFY_DEPLOY_HOOK: ${{ secrets.COOLIFY_DEPLOY_HOOK }}
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        run: |
          echo "üöÄ Triggering Coolify deployment..."
          RESPONSE=$(curl -s -X GET \
            -H "Authorization: Bearer $COOLIFY_TOKEN" \
            "$COOLIFY_DEPLOY_HOOK")

          echo "$RESPONSE"

          DEPLOYMENT_UUID=$(echo "$RESPONSE" | jq -r '.deployments[0].deployment_uuid')
          APP_UUID=$(echo "$RESPONSE" | jq -r '.deployments[0].resource_uuid')

          if [ "$DEPLOYMENT_UUID" = "null" ] || [ -z "$DEPLOYMENT_UUID" ]; then
            echo "‚ùå Failed to extract deployment UUID!"
            exit 1
          fi

          echo "deployment_uuid=$DEPLOYMENT_UUID" >> $GITHUB_OUTPUT
          echo "app_uuid=$APP_UUID" >> $GITHUB_OUTPUT

      - name: Wait for deployment to finish
        id: wait
        env:
          BASE_URL: ${{ secrets.COOLIFY_BASE_URL }}
          DEPLOYMENT_UUID: ${{ steps.trigger.outputs.deployment_uuid }}
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        run: |
          echo "‚è≥ Waiting for deployment with ID $DEPLOYMENT_UUID to finish..."
          STATUS="in_progress"
          TIMEOUT=180   # 3 minutes
          INTERVAL=4
          ELAPSED=0

          while [[ "$STATUS" != "finished" && "$STATUS" != "failed" && $ELAPSED -lt $TIMEOUT ]]; do
            echo "curl -s -H Authorization: Bearer $COOLIFY_TOKEN $BASE_URL/deployments/$DEPLOYMENT_UUID"
            STATUS=$(curl -s \
              -H "Authorization: Bearer $COOLIFY_TOKEN" \
              "$BASE_URL/deployments/$DEPLOYMENT_UUID" | jq -r '.status')

            echo "‚û°Ô∏è  Current status: $STATUS (elapsed: ${ELAPSED}s)"

            if [[ "$STATUS" == "finished" ]]; then
              echo "‚úÖ Deployment finished successfully!"
              break
            elif [[ "$STATUS" == "failed" ]]; then
              echo "‚ùå Deployment failed!"
              exit 1
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          if [[ "$STATUS" != "finished" ]]; then
            echo "‚ùå Deployment did not finish successfully within ${TIMEOUT}s (last status: $STATUS)"
            exit 1
          fi

      - name: Check application health
        env:
          BASE_URL: ${{ secrets.COOLIFY_BASE_URL }}
          APP_UUID: ${{ steps.trigger.outputs.app_uuid }}
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        run: |
          echo "üîç Checking application health for ID $APP_UUID..."

          TIMEOUT=180     # 3 minutes
          INTERVAL=5      # check every 5 seconds
          ELAPSED=0
          STATUS="unknown"

          while [[ $ELAPSED -lt $TIMEOUT ]]; do
            STATUS=$(curl -s \
              -H "Authorization: Bearer $COOLIFY_TOKEN" \
              "$BASE_URL/applications/$APP_UUID" | jq -r '.status')

            echo "‚û°Ô∏è  Current app status: $STATUS (elapsed: ${ELAPSED}s)"

            if [[ "$STATUS" == "running"* ]]; then
              echo "‚úÖ App is running successfully!"
              exit 0
            fi

            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "‚ùå App did not become healthy within ${TIMEOUT}s (last status: $STATUS)"
          exit 1
